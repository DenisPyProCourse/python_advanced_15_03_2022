# django_lms

## Lesson 01
1. Создали новый проект - прототип **LMS**.
2. Создали приложение **students** и модель **Student**.
3. Добавили **vie**w - функцию для отображения студентов на основании параметров GET запроса.

## Lesson 02


## Lesson 03


## Lesson 04
- Базовый шаблон для всего проекта (root **templates** folder)
```python
TEMPLATES = [
    {
        'DIRS': [BASE_DIR / 'templates'],
    }
]
```
- Создали шаблон для обновления студента и изменили view-функцию
- Создали шаблон и view-функцию для удаления студента
- Добавили обработку неверного запроса (**get_object_or_404**)
- Расширили маршрутизатор проекта
- Добавили имена маршрутам
> Добавили имя приложения в маршрутизатор приложения
- Заменили хард-код ссылки на динамически создаваемые
```python
from django.urls import reverse

print(reverse('list'))
```
```html
{% url 'students:list' %}
```
- Добавили новое приложение **core**
- Вынесли общие валидаторы и view-функцию **index** в новое приложение
- Добавили табличную разметку и стилевое оформление в шаблон **students/list.html**

## Lesson 05
- Подключили загрузку переменных окружения из файла **.env**
- Удалено поле **age** из модели **Student**
- Создали метод для динамического вычисления возраста
- Подключили **bootstrap5**
- Изменили базовый шаблон
- Добавили навигационную панель
- Добавили стили кнопкам и таблице
- Добавили иконку в панель меню
- Включили контент в контейнер
- Зафиксировали панель меню
- Добавили оформление формам (применили **crispy-forms**)
- Изменили формат отображения дат.

## Lesson 06
- Форма поиска на основе django-filters
  - Создали форму фильтра
  - Изменили view-функцию (**get_students**) для работы с формой фильтром
  - Изменили шаблон списка студентов
- Связали модель Group с моделью Student связью **one-2-many**
- В SQLite поддержка ссылочной целостности данных - отключена.
  - проверить включена ли поддержка
  ```sql
  PRAGMA foreign_keys;
  ```
  - включить поддержку можно
  ```sql
  PRAGMA foreign_keys = ON;
  ```
  - отключить поддержку можно
  ```sql
  PRAGMA foreign_keys = OFF;
  ```
- Добавили две view-функции в приложение Groups
  - get_groups
  - update_group
- На форме обновления группы, добавили отображение списка студентов этой группы
- Вынесли отображение списка студентов в отдельный HTML файл

## Lesson 07
- Добавили Django Debug Toolbar
- Получение из базы необходимых данных в одном запросе
```sql
select *
from students as s 
    left join groups as g on d.id = s.group_id;
```
```python
students = Student.objects.all().select_related('group')
```
- Добавляем "старосту группы" - реализация связи One-2-One
```python
headman = models.OneToOneField(
        "students.Student",         # отложенный импорт
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='headman_group'
    )
```
- Добавляем учителей - **Teachers**
  - Создаём модель учителя
- Вынесли общие поля, для студентов и учителей, в общую модель
  - туда же перенесли валидаторы
  - определили генератор фейковых данных который будем переопределять 
в соответствующих моделях
- Изменили модели Student и Teacher
- Связываем модель учителей и групп посредством **Many-2-Many**
  - поле для выбора учителя на форме обновления группы появилось автоматом
  - можем выбирать несколько учителей
- Оптимизировали выборку данных для группы (поиск старосты)

## Lesson 08
- Выделили общую часть view-функции update для **Student** и **Group** приложений и описали в виде 
настраиваемого класса **UpdateBaseView**
- Создали класс (**UpdateStudent**) и унаследовали (в модуле view.py - **Student**) от **UpdateBaseView**
  - надо отключить валидатор номера телефона
- Рассмотрели стандартные [Class Based View](https://ccbv.co.uk)
- Создали новое view (**UpdateStudentView**) на основе классов для студентов
- Создали новое view (**UpdateGroupView**) на основе классов для групп
  - Переопределили метод **get_context_data** для передачи доп. параметров в контекст шаблона
  - Доработали форму редактирования группы
    - Переопределили поле выбора старосты группы, добавив инициализатор формы
  - Доработали view (**UpdateGroupView**) редактирования группы
    - Переопределили метод **get_initial** для правильной инициализации нового поля выбора
    - Связали новое поле формы с атрибутом модели, переопределив метод **form_valid**
- Создали новое view (**ListGroupView**) для отображения групп
  - Изменили имя объекта хранящего группы в шаблоне
- Создали новые view (**CreateGroupView**), шаблон (**create.html**) и форму (**GroupCreateForm**) для 
создания группы
- Создали новые view (**DeleteGroupView**) и шаблон (**group_confirm_delete.html**) для удаления группы
- Создали новое view (**ListStudentView**) для отображения списка студентов
  - Чтоб отобразить форму фильтра на странице, переопределили метод **get_queryset**.

## Lesson 09
- Создаём новое приложение "**Accounts**"
- Создаём форму регистрации (**AccountRegistrationForm**)
- Добавляем маршруты на страницы регистрации, логина и логаута
- Добавляем view классы для обработки маршрутов:
  - логина (**AccountLoginView**)
  - логаута (**AccountLogoutView**)
  - регистрации (**AccountRegistrationView**)
- Добавляем шаблоны:
  - в шаблоны приложения accounts
    - templates/accounts/login.html
    - templates/accounts/logout.html
    - templates/accounts/registration.html
  - в шаблоны проекта
    - templates/password_change_done.html
    - templates/password_change_form.html
    - templates/password_reset_complete.html
    - templates/password_reset_confirm.html
    - templates/password_reset_done.html
    - templates/password_reset_form.html
- Чтоб проверить систему сброса пароля, надо запустить отладочный почтовый сервер:
  ```shell
  python -m smtpd -n -c DebuggingServer localhost:1025
  ```
- В **settings.py** добавляем:
  ```python
  EMAIL_PORT = 1025
  ```
- В главный маршрутизатор добавляем маршрут обслуживающий запросы для сброса и изменения пароля:
  ```python
  path('accounts/', include('django.contrib.auth.urls')),
  ```
- Добавили проверки, авторизован пользователь или нет, в шаблон (меню)
- Эти проверки позволяют:
  - динамически менять меню пользователя
  - прятать некоторые пункты главного меню
- Добавили проверки в view:
  - в классы на основе миксинов - **LoginRequiredMixin**
  - в методы на основе декораторов - **@login_required**
- Добавили профиль пользователя:
  - создали модель **Profile** и связали с пользователем **One-2-One**
  - создали две формы редактирования пользователя (**UserUpdateForm**) и профиля (**ProfileUpdateForm**)
  - создали две view:
    - метод **account_view** для отображения аккаунта
    - класс **AccountUpdateView** для изменения аккаунта
    - добавили два шаблона:
      - profile.html - для отображения аккаунта
      - update.html - для обновления/изменения аккаунта
  - создаём **сигнал** для автоматического создания профиля после создания пользователя.

## Lesson 10 (Admin-site, Middleware, Messages)
- Создали супер-юзера
- Подключаем модель **Student** в админ панель
- Настраиваем отображение модели **Student** (**StudentAdmin**):
  - изменяем отображение списка записей модели
    - отображаемые поля, ссылки, пагинатор
    - добавили поисковую форму 
    - добавили фильтр отображаемых записей
  - изменяем форму редактирования записи
    - меняем порядок отображения полей
    - добавляем отображение несуществующего поля (**age**)
    - меняем **TIME_ZONE**
    - определяем поля - только чтение
- Подключаем модель **Group** в админ панель
- Настраиваем отображение модели **Group** (**GroupAdmin**):
  - изменяем отображение списка записей модели
  - изменяем форму редактирования записи
    - добавляем отображение списка студентов в группе (StudentsInlineTable)
    - убираем возможность добавления/удаления студента через форму редактирования Группы
- Создаём свой **middleware** считающий время затрачиваемое на обработку запроса 
пользователя (**CalculateRequestTimeMiddleware**)
- Создаём новый **include HTML** файл для отображения сообщений (**messages.html**)
- Добавляем сообщение на событие входа пользователя

## Lesson 11 (Paginator, Context-processor, Signals, Flat pages, CKEditor, Avatars)
- Добавили в админку группы Inline таблицу списка учителей
- Пагинация
  ```python
  from students.models import Student
  from django.core.paginator import Paginator
  
  st = Student.objects.all().order_by('pk')
  p = Paginator(st, 10)
  
  p.count                     # общее кол-во записей
  p.num_pages                 # кол-во страниц пагинации
  p.page_range                # диапазон номеров страниц
  
  page = p.page(5)            # получаем страницу под номером 5
  page.object_list            # список записей на странице
  page.start_index()          # индекс первой записи на странице относительно общего кол-ка записей
  page.has_previous           # возвращает True если есть предыдущая страница, иначе False
  page.previous_page_number   # возвращает номер предыдущей страницы
  page.has_next               # возвращает True если есть следующая страница, иначе False
  page.next_page_number       # возвращает номер следующей страницы
  ```
  - добавляем пагинатор на страницу отображения списка студентов
    - изменяем метод **get_queryset** в представлении **ListStudentView**, возвращаем чистый **queryset**
    - переопределяем метод **get_context_data**, добавляем в него форму фильтра
    - создаем метод **get_filter** возвращающий объект фильтра
    - в класс **ListStudentView** добавляем атрибут **paginate_by**
    - создаём доп. HTML файл **paginator.html** и вставляем в него код пагинатора из документации **Django**
    - в базовом шаблоне подключаем пагинатор используя проверку атрибута **is_paginated**
    - изменяем стандартный вид пагинатора на оформление из **bootstrap**
    - добавляем кнопки **First** и **Last**

- Исправляем **GET** запрос при использовании фильтра вместе с пагинатором
  - изменяем **view** отображения списка студентов или
  - создаём **context-processor**
- Система сигналов
- **Flat pages** - плоские страницы
- Подключаем **WYSIWYG** редактор - [CKEditor](https://django-ckeditor.readthedocs.io/en/latest/)
  - для исправления отображения картинки на странице необходимо сделать следующие изменения
  ```python
  # settings.py
  
  MEDIA_URL = 'media/'
  MEDIA_ROOT = BASE_DIR / 'media'
  ```
  
  ```python
  # urls.py (маршрутизатор проекта)
  
  if settings.DEBUG:
      urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
  ```
  после надо обновить **Content** на странице **About**
- Добавляем в профиль аватарку
  - меняем модель профиля
  - меняем форму обновления профиля
  - меняем представление AccountUpdateView
  - меняем шаблон accounts/update.html
  - изменяем админку для отображения пользователя и профиля
